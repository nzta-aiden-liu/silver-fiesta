name: Fetch Confluence Pages

on:
  workflow_dispatch:

jobs:
  fetch-pages:
    runs-on: ubuntu-latest
    env:
      CONFLUENCE_PAGE_BASE: https://waka-kotahi.atlassian.net/wiki/api/v2/pages
      EMAIL: ${{ vars.CONFLUENCE_EMAIL }}
      API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Prepare pages directory
        run: mkdir -p pages

      - name: Fetch pages from Confluence
        run: |
          set -euo pipefail
          ids=$(jq -r '.page_ids[]' config.json)
          for id in $ids; do
            echo "Fetching page $id"
            echo "Full url: $CONFLUENCE_PAGE_BASE/$id?body-format=storage"
            curl --request GET \
              --url "$CONFLUENCE_PAGE_BASE/$id?body-format=storage" \
              --user "$EMAIL:$API_TOKEN" \
              --header 'Accept: application/json' | jq -r '.body.storage.value' > pages/page_${id}.html
          done

      - name: Upload pages artifact
        uses: actions/upload-artifact@v4
        with:
          name: confluence-pages
          path: pages
