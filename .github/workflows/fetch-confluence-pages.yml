name: Fetch Confluence Pages

on:
  workflow_dispatch:

jobs:
  fetch-pages:
    runs-on: ubuntu-latest
    env:
      CONFLUENCE_PAGE_BASE: https://waka-kotahi.atlassian.net/wiki/api/v2/pages
      EMAIL: ${{ vars.CONFLUENCE_EMAIL }}
      API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Prepare pages directory
        run: mkdir -p pages

      - name: Fetch pages from Confluence
        run: |
          set -euo pipefail
          jq -r '.pages[] | "\(.id) \(.version)"' config.json | while read id version; do
            echo "Fetching page $id (version: $version)"
            url="$CONFLUENCE_PAGE_BASE/$id?body-format=storage"
            if [ "$version" != "latest" ]; then
              url="$url&version=$version"
            fi
            echo "Full url: $url"
            response=$(curl --request GET \
              --url "$url" \
              --user "$EMAIL:$API_TOKEN" \
              --header 'Accept: application/json')
            actual_version=$(echo "$response" | jq -r '.version.number')
            echo "Page version: $actual_version"
            echo "<!-- Version: $actual_version -->" > pages/page_${id}.html
            echo "$response" | jq -r '.body.storage.value' >> pages/page_${id}.html
          done

      - name: Upload pages artifact
        uses: actions/upload-artifact@v4
        with:
          name: confluence-pages
          path: pages
